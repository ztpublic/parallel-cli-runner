use std::fs;
use std::path::PathBuf;

use parallel_cli_runner_lib::git::{
    BranchInfoDto, CommitInfoDto, DiffCompareKind, DiffDeltaStatus, DiffFileSummaryDto,
    DiffMetaDto, DiffRequestDto, DiffRequestOptionsDto, DiffResponseDto, DiffStatDto,
    FileChangeType, FileStats, FileStatusDto, RemoteInfoDto, RepoInfoDto, RepoStatusDto,
    StashInfoDto, SubmoduleInfoDto, TagInfoDto, WorktreeInfoDto,
};
use ts_rs::TS;

fn main() {
    let manifest_dir = std::env::var("CARGO_MANIFEST_DIR").unwrap();
    let types_dir = PathBuf::from(manifest_dir)
        .parent()
        .expect("parent directory should exist")
        .join("src/types");

    fs::create_dir_all(&types_dir).expect("failed to create types directory");

    // git.ts
    // Add a header to indicate generation
    let mut git_ts = String::from("// This file was generated by [ts-rs]. Do not edit this file manually.\n");
    git_ts.push_str("// To regenerate: cargo run --bin export_types --manifest-path src-tauri/Cargo.toml\n\n");
    git_ts.push_str(&FileChangeType::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&FileStats::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&FileStatusDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&CommitInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&RepoInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&RepoStatusDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffStatDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffCompareKind::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffDeltaStatus::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffRequestOptionsDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffRequestDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffFileSummaryDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffMetaDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&DiffResponseDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&BranchInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&RemoteInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&SubmoduleInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&WorktreeInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&StashInfoDto::decl().replace("type ", "export type "));
    git_ts.push_str("\n\n");
    git_ts.push_str(&TagInfoDto::decl().replace("type ", "export type "));

    fs::write(types_dir.join("git.ts"), git_ts).expect("failed to write git.ts");

    println!("TypeScript types exported to: {}", types_dir.join("git.ts").display());
    println!("\nNote: git-ui.ts types are manually maintained and serve as UI-layer types.");
    println!("They are intentionally separate from DTOs and may have different field names.");
}
